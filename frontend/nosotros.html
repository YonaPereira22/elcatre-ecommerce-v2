<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Nosotros ‚Äî El Catre S.R.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">

  <style>
  /* === Paleta y base === */
  :root{--azul:#17468f;--blanco:#fff;--gris:#f3f5f7;--tx:#111}
  body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:linear-gradient(180deg,#f7f9ff 0%,#fff 100%);
    color:var(--tx);
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:0 16px}

  /* === HEADER === */
  .topbar{
    position:sticky;
    top:0;
    z-index:40;
    background:var(--azul);
    color:#fff;
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  .topbar .wrap{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:10px 0;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .brand img{height:34px;border-radius:6px}
  .brand strong{font-size:18px;letter-spacing:.3px}
  .menu{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .menu a{
    padding:8px 10px;
    border-radius:8px;
    color:#fff;
  }
  .menu a:hover,
  .menu a.active{
    background:rgba(255,255,255,0.2);
  }
  .auth{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .btn{
    padding:8px 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.5);
    background:transparent;
    color:#fff;
    cursor:pointer;
    font-weight:600;
  }
  .btn.white{
    background:#fff;
    color:var(--azul);
    border-color:#fff;
  }

  /* === CONTENIDO === */
  .content{
    max-width:900px;
    margin:30px auto;
    padding:0 16px;
  }
  .content h1{
    color:var(--azul);
    text-align:center;
  }
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
  }
  @media(max-width:900px){
    .grid{grid-template-columns:1fr}
  }
  .card{
    background:#fff;
    border:1px solid #e8edf3;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.05);
    padding:16px;
  }
  .stars{display:flex;gap:6px;font-size:22px;cursor:pointer}
  .stars .s{color:#ccc}
  .stars .s.active{color:#f5b301}
  .field{margin:10px 0}
  input,textarea{
    width:100%;
    padding:10px;
    border:1px solid #dbe2ea;
    border-radius:8px;
  }
  textarea{min-height:100px;resize:vertical}
  .op{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .op .it{border-bottom:1px dashed #eaeff0;padding-bottom:10px}
  .muted{color:#666}
</style>


</head>
<body>

<header class="topbar">
  <div class="container wrap">
    <a class="brand" href="index.html">
      <img src="img/logo-el-catre.jpg" alt="El Catre S.R.L">
      <strong>El Catre S.R.L</strong>
    </a>
    <nav class="menu">
      <a href="index.html">Inicio</a>
      <a href="#catalogo">Productos</a>
      <a href="carrito.html">Carrito</a>
      <a href="nosotros.html">Nosotros</a>
      <a href="politicas.html">Pol√≠ticas</a>
    </nav>
    <div class="auth" id="auth-box">
      <a class="btn" href="login.html">Login</a>
      <a class="btn white" href="register.html">Registrarse</a>
    </div>
  </div>
</header>


<!-- ======= Contenido principal ======= -->
<main class="content">
  <h1>Nosotros</h1>
  <div class="grid">
    <section class="card">
      <h2>El Catre S.R.L ‚Äî Muebler√≠a</h2>
      <div style="height:20px;"></div>  
      <p>Somos una <strong>Muebler√≠a</strong> El Catre S.R.L, con base en Santa Clara de Olimar. Nuestro objetivo es ofrecer un cat√°logo claro, carrito y compra simple, coordinando env√≠os en todo el pa√≠s y servicio de armado dentro de Santa Clara.</p>
      <div style="height:20px;"></div>
      <p><strong>Contacto:</strong> WhatsApp 099 227 298 ¬∑ Instagram <a href="https://www.instagram.com/elcatre.srl" target="_blank">@elcatre.srl</a></p>
      <div style="height:20px;"></div>
      <p><strong>Env√≠os:</strong> Gratis dentro de Santa Clara; resto del pa√≠s con operadores terceros (seg√∫n zona/volumen).</p>
      <div style="height:20px;"></div>
      <p><strong>Armado:</strong> Para muebles, en la misma entrega si es posible; si no, se coordina segunda visita.</p>
      <div style="text-align:center; margin-top:16px;">
      <img src="img/logo-el-catre.jpg" alt="Logo El Catre S.R.L" style="width:250px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
      </div>
  
    </section>

    <!-- ========= Rese√±as ========= -->
    <section class="card">
      <h2>Opiniones de nuestros clientes</h2>

      <div class="field">
        <label>Nombre</label>
        <input id="rev-nombre" placeholder="Tu nombre">
      </div>

      <div class="field">
        <label>Calificaci√≥n</label>
        <div class="stars" id="rev-stars" aria-label="Calificaci√≥n de 1 a 5">
          <span class="s" data-v="1">‚òÖ</span>
          <span class="s" data-v="2">‚òÖ</span>
          <span class="s" data-v="3">‚òÖ</span>
          <span class="s" data-v="4">‚òÖ</span>
          <span class="s" data-v="5">‚òÖ</span>
        </div>
      </div>

      <div class="field">
        <label>Comentario</label>
        <textarea id="rev-coment" placeholder="Dej√° tu opini√≥n (20‚Äì400 caracteres)"></textarea>
      </div>

      <button class="btn" id="rev-enviar">Enviar rese√±a</button>

      <hr style="margin:16px 0">
      <div class="op" id="rev-list"></div>
    </section>
  </div>
</main>

<!-- ======= Script de rese√±as ======= -->


<script>
document.addEventListener("DOMContentLoaded", async function() {
  const authBox = document.getElementById('auth-box');
  if (!authBox) return;

  // --- Recuperar del almacenamiento local
  let user = null;
  try {
    user = JSON.parse(localStorage.getItem('usuarioActual')) || null;
  } catch(e) {
    user = null;
  }

  // --- Verificar sesi√≥n con el backend
  try {
    const res = await fetch('http://localhost/Muebleria/backend/api.php?action=auth_me', {
      credentials: 'include'
    });
    const data = await res.json();
    if (data.authenticated && data.user) {
      user = data.user;
      localStorage.setItem('usuarioActual', JSON.stringify(user));
    }
  } catch(err) {
    console.warn('No se pudo verificar la sesi√≥n con el backend', err);
  }

  // --- Mostrar seg√∫n el estado
  if (user) {
    authBox.innerHTML = `
      <span>üëã Hola, <strong>${user.nombre || user.email}</strong></span>
      <button class="btn white" onclick="logout()">Cerrar sesi√≥n</button>
    `;
  } else {
    authBox.innerHTML = `
      <a class="btn" href="login.html">Login</a>
      <a class="btn white" href="register.html">Registrarse</a>
    `;
  }

  // --- Cierre de sesi√≥n global
  window.logout = async function() {
    localStorage.removeItem('usuarioActual');
    try {
      await fetch('http://localhost/Muebleria/backend/api.php?action=auth_logout', {
        method: 'POST',
        credentials: 'include'
      });
    } catch(e) {}
    location.href = 'login.html';
  };
});
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const LS_KEY = 'opiniones_elcatre';
  let currentStars = 0;

  // === Espera a que el login guarde usuarioActual en localStorage ===
  async function getUsuarioActual() {
    return new Promise(resolve => {
      const check = () => {
        try {
          const usr = JSON.parse(localStorage.getItem('usuarioActual'));
          if (usr && (usr.nombre || usr.email)) return resolve(usr);
        } catch(e) {}
        setTimeout(check, 200); // reintenta cada 0.2s hasta que el login cargue
      };
      check();
    });
  }

  const usuario = await getUsuarioActual();
  await loadReviews(); // üîπ Esto carga las rese√±as para todos los visitantes

  // === Referencias del DOM ===
  const nombreInput = document.getElementById('rev-nombre');
  const comentarioInput = document.getElementById('rev-coment');
  const enviarBtn = document.getElementById('rev-enviar');
  const starsContainer = document.getElementById('rev-stars');

  if (!nombreInput || !comentarioInput || !enviarBtn) return;

  // üîß Asegurar visibilidad del bot√≥n
  enviarBtn.style.display = "block";
  enviarBtn.style.marginTop = "10px";
  enviarBtn.style.width = "100%";
  enviarBtn.style.background = "#17468f";
  enviarBtn.style.color = "white";
  enviarBtn.style.border = "none";
  enviarBtn.style.borderRadius = "8px";
  enviarBtn.style.padding = "10px";
  enviarBtn.style.fontWeight = "600";
  enviarBtn.style.cursor = "pointer";


  // === Mostrar formulario seg√∫n login ===
  if (usuario && (usuario.nombre || usuario.email)) {
    nombreInput.value = usuario.nombre || usuario.email;
    nombreInput.disabled = true;
    comentarioInput.disabled = false;
    enviarBtn.disabled = false;
    enviarBtn.style.opacity = "1";
  } else {
    nombreInput.placeholder = "Inici√° sesi√≥n para dejar una rese√±a";
    nombreInput.disabled = true;
    comentarioInput.disabled = true;
    enviarBtn.disabled = true;
    enviarBtn.style.opacity = "0.5";
  }

  // === Manejo de estrellas ===
  if (starsContainer) {
    starsContainer.addEventListener('click', e => {
      if (e.target.classList.contains('s')) {
        currentStars = Number(e.target.dataset.v);
        paintStars(currentStars);
      }
    });
  }

  function paintStars(n) {
    document.querySelectorAll('#rev-stars .s').forEach(el => {
      el.classList.toggle('active', Number(el.dataset.v) <= n);
    });
  }

  // === Enviar rese√±a (versi√≥n mejorada) ===
const API = window.location.origin + "/Muebleria/backend/api.php";

enviarBtn.addEventListener('click', async () => {
  if (!usuario) {
    alert("Debes iniciar sesi√≥n para dejar una rese√±a.");
    return;
  }

  const nombre = nombreInput.value.trim();
  const coment = comentarioInput.value.trim();

  if (!nombre) return alert('Ingres√° tu nombre');
  if (currentStars < 1) return alert('Eleg√≠ una calificaci√≥n');
  if (coment.length < 10 || coment.length > 400)
    return alert('El comentario debe tener entre 10 y 400 caracteres');

  const data = {
    nombre: nombre,
    email: usuario.email || '',
    estrellas: currentStars,
    comentario: coment
  };

  try {
    const res = await fetch(API + '?action=addReview', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'include'
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const json = await res.json();

    if (json.ok) {
      alert('‚úÖ ¬°Gracias por tu rese√±a!');
      comentarioInput.value = '';
      currentStars = 0;
      paintStars(0);
      //await loadReviews(); // refresca la lista
    } else {
      alert('Error: ' + (json.error || 'No se pudo guardar la rese√±a'));
    }
  } catch (err) {
    console.error("Error al conectar con el servidor:", err);
    alert('‚ùå Error al conectar con el servidor. Detalle: ' + err.message);
  }
});

  
  // === Cargar rese√±as desde la base de datos ===
async function loadReviews() {
  const cont = document.getElementById('rev-list');
  cont.innerHTML = '<span class="muted">Cargando rese√±as...</span>';

  try {
    const res = await fetch('http://localhost/Muebleria/backend/api.php?action=getReviews');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      cont.innerHTML = '<span class="muted">Todav√≠a no hay opiniones.</span>';
      return;
    }

    cont.innerHTML = data.map(x => {
      const estrellas = '‚òÖ'.repeat(x.estrellas) + '‚òÜ'.repeat(5 - x.estrellas);
      const fecha = new Date(x.fecha).toLocaleDateString('es-UY');
      return `
        <div class="it">
          <div><strong>${x.nombre}</strong> ‚Äî <span class="muted">${fecha}</span></div>
          <div style="color:#f5b301;font-size:14px">${estrellas}</div>
          <div>${x.comentario}</div>
        </div>`;
    }).join('');
  } catch (err) {
    console.error('Error al cargar rese√±as:', err);
    cont.innerHTML = '<span class="muted">‚ö†Ô∏è No se pudieron cargar las rese√±as.</span>';
  }
}


// === Ejecutar al cargar la p√°gina ===
await loadReviews();
paintStars(0);

});

</script>

</body>
</html>