
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Checkout ‚Äî El Catre S.R.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--azul:#17468f;--b:#111;--borde:#e5eaf1;--bg:#f6f8fb}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#f7f9ff 0%,#fff 100%)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}

    header{background:var(--azul);color:#fff}
    header .wrap{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    header img{height:32px;border-radius:6px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin:18px 0}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--borde);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--borde)}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--borde);border-radius:8px;background:#fff}
    textarea{min-height:88px;resize:vertical}
    .chk{display:flex;gap:8px;align-items:center;margin-top:8px}
    .btn{display:inline-block;background:var(--azul);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .muted{color:#666}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .total{font-size:18px;font-weight:800}
    .empty{padding:10px;background:#fff5f5;border:1px solid #ffdede;border-radius:8px}
    .ok{padding:10px;background:#f0fff3;border:1px solid #beefc3;border-radius:8px;margin-bottom:12px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;gap:12px;border-bottom:1px dashed #eaeff6;padding-bottom:8px}
    .item:last-child{border-bottom:0}

    /* NUEVO: m√©todos de entrega */
    .radio-list{display:grid;gap:8px;margin:10px 0}
    .radio-item{display:flex;gap:10px;align-items:flex-start;background:#f8fafc;border:1px solid var(--borde);border-radius:10px;padding:10px}
    .radio-item strong{display:block}
    .fieldset{display:grid;gap:8px;margin:14px 0}
    .fieldset.inline{grid-template-columns:1fr 1fr}
    @media (max-width: 700px){ .fieldset.inline{grid-template-columns:1fr} }
    .hidden{display:none !important}
  
    #metodos-pago {
  background: #f4f7fb;
  border: 1px solid var(--borde);
  border-radius: 12px;
  padding: 14px;
  margin-top: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.05);
}

  #metodos-pago p {
    font-weight: 600;
    color: var(--azul);
    margin-bottom: 10px;
  }

  #metodos-pago .btn {
    margin: 5px;
    background: var(--azul);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background .2s;
  }

  #metodos-pago .btn:hover {
    background: #103469;
  }

  .modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  width: 320px;
  box-shadow: 0 4px 15px rgba(0,0,0,.3);
}
.modal-content h2 {
  text-align: center;
  color: #17468f;
  margin-bottom: 15px;
}
.modal-content input {
  width: 100%;
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.modal-content .acciones {
  display: flex;
  justify-content: space-between;
}
.btn-secondary {
  background: #ccc;
  color: #333;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}


  </style>
</head>
<body>

<header>
  <div class="container wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="img/logo-el-catre.jpg" alt="El Catre">
      <strong>El Catre ‚Äî Muebler√≠a</strong>
    </div>
    <nav>
      <a href="index.html" style="color:#fff;margin-right:10px">Inicio</a>
      <a href="carrito.html" style="color:#fff">Carrito</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">

    <!-- FORMULARIO -->
    <section class="card">
      <h2>Datos para la entrega</h2>
      <div class="body">
        <div id="msg" class="ok" style="display:none"></div>

        <!-- Contacto -->
        <div class="row">
          <div>
            <label>Nombre y apellido</label>
            <input id="nombre" placeholder="Ej: Juan P√©rez" required>
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="tu@correo.com" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Celular</label>
            <input id="telefono" placeholder="Ej: 09x xxx xxx">
          </div>
          <div>
            <label>Departamento</label>
            <select id="departamento">
              <option value="">Seleccionar‚Ä¶</option>
              <option>Montevideo</option><option>Canelones</option><option>Maldonado</option>
              <option>Lavalleja</option><option>Rocha</option><option>Tacuaremb√≥</option>
              <option>Treinta y Tres</option><option>Florida</option><option>Durazno</option>
              <option>Colonia</option><option>Flores</option><option>San Jos√©</option>
              <option>Artigas</option><option>Salto</option><option>Paysand√∫</option>
              <option>Rivera</option><option>Rio Negro</option><option>Soriano</option>
              <option>Cerro Largo</option>
            </select>
          </div>
        </div>

        <!-- Direcci√≥n base (se usa en SC y en interior si quer√©s) -->
        <div class="row">
          <div>
            <label>Ciudad/Localidad</label>
            <input id="ciudad" placeholder="Ej: Santa Clara de Olimar">
          </div>
          <div>
            <label>Direcci√≥n</label>
            <input id="direccion" placeholder="Calle, n√∫mero, apto/casa">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Referencias de acceso</label>
            <textarea id="referencias" placeholder="Piso/ascensor, ancho de puertas, referencias‚Ä¶"></textarea>
          </div>
          <div>
            <label>Agenda preferida</label>
            <input id="agenda" type="date">
            <div class="muted">Coordinamos por email/WhatsApp la franja horaria</div>
            <!-- quitamos ‚Äúretira_local‚Äù checkbox: ahora es un m√©todo -->
            <label class="chk"><input type="checkbox" id="factura_empresa"> Factura para empresa (RUT)</label>
            <input id="rut" placeholder="RUT (si corresponde)" style="margin-top:6px;display:none">
          </div>
        </div>

        <hr>

        <!-- M√âTODO DE ENTREGA (NUEVO) -->
        <h3 style="margin:0 0 8px">M√©todo de entrega</h3>
        <div class="radio-list" id="metodos">
          <!-- 1) Armado SC -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="armado_sc" required>
            <div>
              <strong>Armado en domicilio ‚Äî Santa Clara</strong>
              <span class="muted">Armado por personal en Santa Clara. Requiere direcci√≥n.</span>
            </div>
          </label>
          <!-- 4) Env√≠o gratis SC -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="envio_gratis_sc" required>
            <div>
              <strong>Env√≠o <u>gratis</u> ‚Äî Santa Clara</strong>
              <span class="muted">Franja horaria: 08‚Äì12 o 14‚Äì18. Requiere direcci√≥n.</span>
            </div>
          </label>
          <!-- 2) Retiro local -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="retiro_local" required>
            <div>
              <strong>Retiro en local</strong>
              <span class="muted">Coordin√° d√≠a y horario de retiro.</span>
            </div>
          </label>
          <!-- 3) Interior -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="envio_interior" required>
            <div>
              <strong>Env√≠o Interior (DAC, Mirtrans, Nu√±ez)</strong>
              <span class="muted">Despacho por empresa. Requiere datos del receptor y ciudad.</span>
            </div>
          </label>
        </div>

        <!-- GRUPOS CONDICIONALES -->
        <!-- Para SC (armado/env√≠o gratis) -->
        <div id="grp-direccion-sc" class="fieldset hidden">
          <label for="direccion_sc">Direcci√≥n (Santa Clara de Olimar)</label>
          <input type="text" id="direccion_sc" placeholder="Calle, n√∫mero, esquina, referencias">
        </div>

        <!-- Franja para ‚Äúenv√≠o gratis SC‚Äù -->
        <div id="grp-franja" class="fieldset inline hidden">
          <div>
            <label for="franja">Franja horaria</label>
            <select id="franja">
              <option value="">Eleg√≠‚Ä¶</option>
              <option value="08-12">08:00 a 12:00</option>
              <option value="14-18">14:00 a 18:00</option>
            </select>
          </div>
        </div>

        <!-- Retiro en local -->
        <div id="grp-retiro" class="fieldset inline hidden">
          <div>
            <label for="retiro_fecha">D√≠a de retiro</label>
            <input type="date" id="retiro_fecha">
          </div>
          <div>
            <label for="retiro_hora">Horario</label>
            <input type="time" id="retiro_hora">
          </div>
        </div>

        <!-- Env√≠o interior -->
        <div id="grp-interior" class="fieldset hidden">
          <div class="row">
            <div>
              <label for="empresa">Empresa</label>
              <select id="empresa">
                <option value="">Eleg√≠ empresa</option>
                <option>DAC</option>
                <option>Mirtrans</option>
                <option>Nu√±ez</option>
                <option>Correo Uruguayo</option>

              </select>
            </div>
            <div>
              <label for="recibe">Nombre de quien recibe</label>
              <input id="recibe" placeholder="Nombre y apellido">
            </div>
          </div>
          <div>
            <label for="ciudad_int">Ciudad (interior)</label>
            <input id="ciudad_int" placeholder="Ciudad/Dpto.">
          </div>
        </div>

        <label style="display:inline-flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600">
            <input type="checkbox" id="acepto">
            <span>Acepto las <a href="politicas.html" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">pol√≠ticas</a></span>
          </label>


        <div style="margin-top:16px">
          <button class="btn" id="btn-pagar">Confirmar pedido</button>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <aside class="card">
      <h2>Resumen del carrito</h2>
      <div class="body">
        <div id="resumen"></div>
        <div id="metodos-pago" style="margin-top:20px; text-align:center; display:none;"></div>
      </div>
    </aside>
  
   <!-- üßæ Modal de pago con tarjeta -->
  <div id="modal-tarjeta" class="modal">
    <div class="modal-content">
      <h2>Pago con tarjeta</h2>
      <form id="form-tarjeta">
        <label>Nombre del titular</label>
        <input type="text" id="nombre-tarjeta" required placeholder="Ej: Juan P√©rez">

        <label>N√∫mero de tarjeta</label>
        <input
          type="text"
          id="numero-tarjeta"
          maxlength="19"               
          placeholder="Ingrese los 16 d√≠gitos"
          required>

        <label>Vencimiento</label>
        <input type="text" id="vencimiento-tarjeta" maxlength="5" placeholder="MM/AA" required>

        <label>CVV</label>
        <input type="password" id="cvv-tarjeta" maxlength="3" placeholder="***" required>

        <div class="acciones">
          <button type="submit" class="btn">üí≥ Confirmar pago</button>
          <button type="button" id="cerrar-modal" class="btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  </div>
</main>

<script>
  const API = 'http://localhost/Muebleria/backend/api.php';
  let datosPedido = null;   // ‚Üê ac√° guardamos los datos hasta que se pague

  // Mostrar RUT si tildan "Factura empresa"
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='factura_empresa'){
      document.getElementById('rut').style.display = e.target.checked ? 'block' : 'none';
    }
  });

  // Cargar resumen desde localStorage (el que usa data.js)
  function cargarResumen(){
    const carrito = JSON.parse(localStorage.getItem('carrito'))||[];
    const total   = parseFloat(localStorage.getItem('total'))||0;
    const div = document.getElementById('resumen');

    if(!carrito.length){
      div.innerHTML = `<div class="empty">Tu carrito est√° vac√≠o. <a href="index.html">Ir al cat√°logo</a></div>`;
      document.getElementById('btn-pagar').disabled = true;
      return;
    }
    
    const items = carrito.map(it => `
      <div class="item">
        <span>${it.nombre}</span>
        <strong>UYU ${it.precio.toLocaleString('es-UY')}</strong>
      </div>
    `).join('');

    div.innerHTML = `
      <div class="list">${items}</div>
      <hr>
      <div class="line"><span>Env√≠o</span><span class="muted">Se coordina</span></div>
      <div class="line total"><span>Total</span><span>UYU ${total.toLocaleString('es-UY')}</span></div>
    `;
  }
  cargarResumen();

  // Prefill b√°sico si hay sesi√≥n (opcional)
  (async function prefill(){
  try{
    const r = await fetch(API + '?action=auth_me', {
      credentials:'include'
    });
    const j = await r.json();
    if (j.authenticated && j.user) {
      document.getElementById('nombre').value = j.user.nombre || '';
      document.getElementById('email').value  = j.user.email  || '';
    }
  }catch(_){}
})();


  // ---------- NUEVO: condicionales de m√©todo de entrega ----------
  (function initMetodo(){
    const radios = document.querySelectorAll('input[name="metodo"]');
    const grpDirSC   = document.getElementById('grp-direccion-sc');
    const dirSC      = document.getElementById('direccion_sc');
    const grpFranja  = document.getElementById('grp-franja');
    const franja     = document.getElementById('franja');
    const grpRetiro  = document.getElementById('grp-retiro');
    const rFecha     = document.getElementById('retiro_fecha');
    const rHora      = document.getElementById('retiro_hora');
    const grpInt     = document.getElementById('grp-interior');
    const empresa    = document.getElementById('empresa');
    const recibe     = document.getElementById('recibe');
    const ciudadInt  = document.getElementById('ciudad_int');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function setReq(el, v){ if(el) el.required = !!v; }

    function apply(value){
      [grpDirSC, grpFranja, grpRetiro, grpInt].forEach(hide);
      [dirSC, franja, rFecha, rHora, empresa, recibe, ciudadInt].forEach(el=> setReq(el,false));

      if(value==='armado_sc'){ show(grpDirSC); setReq(dirSC,true); }
      if(value==='envio_gratis_sc'){ show(grpDirSC); show(grpFranja); setReq(dirSC,true); setReq(franja,true); }
      if(value==='retiro_local'){ show(grpRetiro); setReq(rFecha,true); setReq(rHora,true); const today = new Date(); today.setHours(0,0,0,0); rFecha.min = today.toISOString().slice(0,10); }
      if(value==='envio_interior'){ show(grpInt); setReq(empresa,true); setReq(recibe,true); setReq(ciudadInt,true); }
    }
    radios.forEach(r=>{ r.addEventListener('change', ()=> apply(r.value)); if(r.checked) apply(r.value); });
  })();

  // ‚úÖ Env√≠o del pedido y despliegue de opciones de pago (solo valida y guarda datos)
  document.getElementById('btn-pagar').onclick = async () => {
    const nombre        = document.getElementById('nombre').value.trim();
    const email         = document.getElementById('email').value.trim();
    const telefono      = document.getElementById('telefono').value.trim();
    const departamento  = document.getElementById('departamento').value.trim();
    const ciudad        = document.getElementById('ciudad').value.trim();
    const direccion     = document.getElementById('direccion').value.trim();
    const referencias   = document.getElementById('referencias').value.trim();
    const agenda        = document.getElementById('agenda').value;
    const facturaEmpresa= document.getElementById('factura_empresa').checked;
    const rut           = document.getElementById('rut').value.trim();
    const acepto        = document.getElementById('acepto').checked;

    const metodo   = (document.querySelector('input[name="metodo"]:checked') || {}).value;
    const dirSC    = document.getElementById('direccion_sc')?.value.trim() || '';
    const franja   = document.getElementById('franja')?.value || '';
    const rFecha   = document.getElementById('retiro_fecha')?.value || '';
    const rHora    = document.getElementById('retiro_hora')?.value || '';
    const empresa  = document.getElementById('empresa')?.value || '';
    const recibe   = document.getElementById('recibe')?.value.trim() || '';
    const ciudadInt= document.getElementById('ciudad_int')?.value.trim() || '';

    const msg = document.getElementById('msg');
    msg.style.display = 'none';
    msg.textContent   = '';

    // ---- Validaciones que ya ten√≠a ----
    if (!acepto)            { alert('Deb√©s aceptar las pol√≠ticas'); return; }
    if (!nombre || !email)  { alert('Complet√° nombre y email');    return; }
    if (!metodo)            { alert('Eleg√≠ un m√©todo de entrega'); return; }

    if (metodo === 'armado_sc'       && !dirSC)                       { alert('Ingres√° la direcci√≥n para armado en Santa Clara.'); return; }
    if (metodo === 'envio_gratis_sc' && (!dirSC || !franja))          { alert('Ingres√° la direcci√≥n y franja horaria.');           return; }
    if (metodo === 'retiro_local'    && (!rFecha || !rHora))          { alert('Eleg√≠ d√≠a y hora de retiro.');                      return; }
    if (metodo === 'envio_interior'  && (!empresa || !recibe || !ciudadInt)) {
      alert('Complet√° empresa, receptor y ciudad.');
      return;
    }

    let metodoStr = '';
    let extra     = '';
    if (metodo === 'armado_sc') {
      metodoStr = 'Armado en domicilio ‚Äî Santa Clara';
      extra     = `Dir SC: ${dirSC}`;
    }
    if (metodo === 'envio_gratis_sc') {
      metodoStr = 'Env√≠o gratis ‚Äî Santa Clara';
      extra     = `Dir SC: ${dirSC} ‚Äî Franja: ${franja}`;
    }
    if (metodo === 'retiro_local') {
      metodoStr = 'Retiro en local';
      extra     = `Retiro: ${rFecha} ${rHora}`;
    }
    if (metodo === 'envio_interior') {
      metodoStr = 'Env√≠o interior';
      extra     = `Empresa: ${empresa} ‚Äî Recibe: ${recibe} ‚Äî Ciudad: ${ciudadInt}`;
    }

    const direccionExtendida =
      `${direccion} ‚Äî ${ciudad}, ${departamento}` +
      (referencias ? ` ‚Äî Ref: ${referencias}` : '') +
      (agenda      ? ` ‚Äî Agenda pref.: ${agenda}` : '') +
      ` ‚Äî [${metodoStr}] ${extra}`;

    // En vez de crear el pedido ac√°, SOLO guardamos los datos
    datosPedido = {
      nombre,
      email,
      telefono,
      direccion: direccionExtendida,
      facturaEmpresa,
      rut,
      metodoEntrega: metodoStr
    };

    // Mensaje al usuario
    msg.innerHTML = '<p>Datos verificados ‚úÖ. Ahora eleg√≠ un m√©todo de pago para finalizar la compra.</p>';
    msg.style.display = 'block';

    // Mostrar botones de pago (como ya hac√≠as)
    const pagos = document.getElementById('metodos-pago');
    pagos.innerHTML = `
      <p>Seleccion√° tu m√©todo de pago:</p>
      <button class="btn" onclick="pagoTarjeta()">üí≥ Tarjeta</button>
      <button class="btn" onclick="pagoMP()">üîó Mercado Pago</button>
      <button class="btn" onclick="pagoTransferencia()">üè¶ Transferencia</button>
    `;
    pagos.style.display = 'block';
  };

    // üîÅ Funci√≥n que S√ç crea el pedido en el servidor (la usan las pasarelas)
  async function crearPedidoEnServidor(metodoPagoTexto) {
    if (!datosPedido) {
      alert('Primero complet√° y confirm√° los datos del pedido.');
      return;
    }

    const { nombre, email, telefono, direccion } = datosPedido;

    const body = new URLSearchParams({
      action   : 'pedido_crear',
      nombre,
      email,
      telefono,
      direccion
    });

    try {
      // 1) sincronizar carrito local ‚Üí backend (como ya hac√≠as)
      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      await fetch(API + '?action=carrito_sync', {
        method     : 'POST',
        credentials: 'include',
        headers    : { 'Content-Type': 'application/json' },
        body       : JSON.stringify(carrito)
      });

      // 2) crear pedido
      const r    = await fetch(API, { method:'POST', body, credentials:'include' });
      const text = await r.text();
      let j;
      try { j = JSON.parse(text); }
      catch { throw new Error('Respuesta no JSON: ' + text); }

      if (!r.ok) {
        alert(j.error || 'No pudimos confirmar el pedido');
        return;
      }

      const msg = document.getElementById('msg');
      msg.innerHTML = `<p>‚úÖ Pedido #${j.pedido_id} confirmado.<br> M√©todo de pago: ${metodoPagoTexto}.</p>`;
      msg.style.display = 'block';

      // limpiar carrito
      localStorage.removeItem('carrito');
      localStorage.removeItem('total');

      // redirigir al inicio
      setTimeout(() => {
        location.href = 'index.html';
      }, 2000);
    } catch (e) {
      console.error(e);
      alert('Error de red al confirmar el pedido.');
    }
  }



  // üí≥ Pasarelas ficticias ‚Äî ahora fuera del onclick ‚úÖ
  function pagoTarjeta() {
  const modal = document.getElementById('modal-tarjeta');
  modal.style.display = 'flex';

  const inputNumero = document.getElementById('numero-tarjeta');
  const inputVto    = document.getElementById('vencimiento-tarjeta');
  const inputCVV    = document.getElementById('cvv-tarjeta');
  const form        = document.getElementById('form-tarjeta');

  // Constantes de longitud
  const CARD_DIGITS = 16; // üëà  esto a 16
  const CVV_DIGITS  = 3;

  // Cerrar modal
  document.getElementById('cerrar-modal').onclick = () => {
    modal.style.display = 'none';
  };

    // Formatear n√∫mero: s√≥lo d√≠gitos, m√°ximo 16, en grupos de 4 con GUIONES
  inputNumero.addEventListener('input', () => {
    // quitamos todo lo que no sea d√≠gito
    let digits = inputNumero.value.replace(/\D/g, '').slice(0, CARD_DIGITS);

    // armamos ####-####-####-####
    const grupos = digits.match(/.{1,4}/g) || [];
    inputNumero.value = grupos.join('-');
  });

  form.onsubmit = async (e) => {
    e.preventDefault();

    // --- Validar n√∫mero de tarjeta ---
    const rawNumber = inputNumero.value.replace(/\D/g, ''); // s√≥lo d√≠gitos
    if (rawNumber.length !== CARD_DIGITS) {
      alert(`N√∫mero de tarjeta inv√°lido. Debe tener exactamente ${CARD_DIGITS} d√≠gitos.`);
      inputNumero.focus();
      return;
    }

    // --- Validar vencimiento (MM/AA) ---
    const vto = inputVto.value.trim();
    const match = /^(\d{2})\/(\d{2})$/.exec(vto);
    if (!match) {
      alert('Vencimiento inv√°lido. Us√° el formato MM/AA.');
      inputVto.focus();
      return;
    }
    const mes = parseInt(match[1], 10);
    if (mes < 1 || mes > 12) {
      alert('Mes de vencimiento inv√°lido (debe ser 01 a 12).');
      inputVto.focus();
      return;
    }

    // --- Validar CVV ---
    const cvv = inputCVV.value.trim();
    if (!/^\d+$/.test(cvv) || cvv.length !== CVV_DIGITS) {
      alert(`CVV inv√°lido. Debe tener exactamente ${CVV_DIGITS} d√≠gitos num√©ricos.`);
      inputCVV.focus();
      return;
    }

    // Si todo est√° OK:
    modal.style.display = 'none';
    alert('‚úÖ Pago procesado con √©xito.');

    // üëâ reci√©n ahora creamos el pedido en el backend
    await crearPedidoEnServidor('Tarjeta');
  };
}

  function pagoMP(){
    if (!datosPedido) {
      alert('Primero confirm√° los datos del pedido.');
      return;
    }

    alert('üîó Redirigiendo a Mercado Pago... (simulaci√≥n)');
    // window.open('https://www.mercadopago.com.uy', '_blank');  // si quer√©s, lo dej√°s

    crearPedidoEnServidor('Mercado Pago');
  }

  function pagoTransferencia(){
  if (!datosPedido) {
    alert('Primero confirm√° los datos del pedido.');
    return;
  }

  alert('üè¶ Transferencia a cuenta BROU 001-2345678.\nEnvi√° el comprobante por WhatsApp.');

  crearPedidoEnServidor('Transferencia bancaria');
}


</script>

<script>
document.addEventListener("DOMContentLoaded", async function() {
  const authBox = document.getElementById('auth-box');
  if (!authBox) return;

  // --- Recuperar del almacenamiento local
  let user = null;
  try {
    user = JSON.parse(localStorage.getItem('usuarioActual')) || null;
  } catch(e) {
    user = null;
  }

  // --- Verificar sesi√≥n con el backend
  try {
    const res = await fetch('http://localhost/Muebleria/backend/api.php?action=auth_me', {
      credentials: 'include'
    });
    const data = await res.json();
    if (data.authenticated && data.user) {
      user = data.user;
      localStorage.setItem('usuarioActual', JSON.stringify(user));
    }
  } catch(err) {
    console.warn('No se pudo verificar la sesi√≥n con el backend', err);
  }

  // --- Mostrar seg√∫n el estado
  if (user) {
    authBox.innerHTML = `
      <span>üëã Hola, <strong>${user.nombre || user.email}</strong></span>
      <button class="btn white" onclick="logout()">Cerrar sesi√≥n</button>
    `;
  } else {
    authBox.innerHTML = `
      <a class="btn" href="login.html">Login</a>
      <a class="btn white" href="register.html">Registrarse</a>
    `;
  }

  // --- Cierre de sesi√≥n global
  window.logout = async function() {
    localStorage.removeItem('usuarioActual');
    try {
      await fetch('http://localhost/Muebleria/backend/api.php?action=auth_logout', {
        method: 'POST',
        credentials: 'include'
      });
    } catch(e) {}
    location.href = 'login.html';
  };
});
</script>

</body>
</html>
